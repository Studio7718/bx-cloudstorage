class extends="BaseTestCase" {
    function beforeAll(){
        super.beforeAll();
    }
    function run(){
        // Load env-driven settings similar to CSDirectoryExistsSpec
        var testPathS3         = getSystemSetting("S3_TEST_PATH_S3", "s3:///my-test-bucket/test-dir/");
        var testLocalFileSmall = getSystemSetting("S3_TEST_LOCAL_FILE_SMALL", "/tmp/s3test/small.txt");
        var testLocalFileLarge = getSystemSetting("S3_TEST_LOCAL_FILE_LARGE", "/tmp/s3test/large.bin");

        // Derive filenames for filtering
        var smallName = listLast( testLocalFileSmall, '/' );
        var largeName = listLast( testLocalFileLarge, '/' );

        // Parse bucket for prefix checks
        var trimmed = replace( testPathS3, "s3://", "", "one" );
        if( left( trimmed, 1 ) == "/" ) trimmed = trimmed.substr( 2 );
        var slashPos = find( "/", trimmed );
        var envBucket = slashPos ? left( trimmed, slashPos - 1 ) : trimmed;

        describe( 'CSDirectoryList BIF (env-configured)', () => {
            it( 'lists entries for configured S3 path (normal usage)', () => {
                var arr = CSDirectoryList( path = testPathS3 );
                expect( isArray( arr ) ).toBeTrue();
                // If there are entries, ensure they are s3 paths in the expected bucket
                if( arrayLen( arr ) ){
                    expect( left( arr[1], 6 ) ).toBe( 's3:///' );
                    expect( findNoCase( '/' & envBucket & '/', arr[1] ) ).toBeGT( 0 );
                }
            });

            it( 'recurses to include nested directories/files', () => {
                var arr = CSDirectoryList( path = testPathS3, recurse = true );
                expect( isArray( arr ) ).toBeTrue();
            });

            it( 'filters by name to show only the small test file', () => {
                var arr = CSDirectoryList( path = testPathS3, filter = smallName );
                expect( isArray( arr ) ).toBeTrue();
                // Expect at least one match and all to end with the file name
                if( arrayLen( arr ) ){
                    expect( right( arr[1], len( smallName ) ) ).toBe( smallName );
                }
            });

            it( 'returns a query when listInfo="query"', () => {
                var q = CSDirectoryList( path = testPathS3, recurse = true, listInfo = 'query', filter = largeName );
                // Ensure query shape if available, else accept array fallback
                if( isQuery( q ) ){
                    expect( q.recordCount ).toBeGTE( 0 );
                    // When rows exist, validate columns contain expected fields
                    if( q.recordCount ){
                        expect( listFindNoCase( q.columnList, 'name' ) ).toBeGTE( 1 );
                        expect( listFindNoCase( q.columnList, 'path' ) ).toBeGTE( 1 );
                        expect( listFindNoCase( q.columnList, 'type' ) ).toBeGTE( 1 );
                    }
                } else {
                    expect( isArray( q ) ).toBeTrue();
                }
            });
        });
    }
}

class extends="coldbox.system.testing.BaseTestCase" appMapping="/" {
    function beforeAll(){
        super.beforeAll();
        // Env-driven paths
        variables.testPathS3         = getSystemSetting("S3_TEST_PATH_S3", "s3:///my-test-bucket/test-dir/");
        variables.testLocalPath      = getSystemSetting("S3_TEST_LOCAL_PATH", "/tmp/s3test/");
        variables.testLocalFileSmall = getSystemSetting("S3_TEST_LOCAL_FILE_SMALL", "/tmp/s3test/small.txt");
        variables.testLocalFileLarge = getSystemSetting("S3_TEST_LOCAL_FILE_LARGE", "/tmp/s3test/large.bin");

        // Ensure local base directory and files exist
        if( !directoryExists( variables.testLocalPath ) ) directoryCreate( variables.testLocalPath, true );
        // Small file
        if( !fileExists( variables.testLocalFileSmall ) ){
            fileWrite( variables.testLocalFileSmall, repeatString( "a", 1024 ) );
        }
        // Large file (approx 256KB)
        if( !fileExists( variables.testLocalFileLarge ) ){
            var chunk = repeatString( "b", 1024 );
            var out = createObject( 'java', 'java.io.FileOutputStream' ).init( variables.testLocalFileLarge );
            try {
                for( var i=1; i<=256; i++ ) out.write( toBinary( toBase64( chunk ) ) );
            } finally { out.close(); }
        }
    }

    function run(){
        // Derive file names
        var smallName = listLast( variables.testLocalFileSmall, '/' );
        var largeName = listLast( variables.testLocalFileLarge, '/' );

        // Randomized sub-paths under the configured S3 test path
        var rand = lcase( replace( createUUID(), '-', '', 'all' ) );
        var s3UploadDest = variables.testPathS3 & 'copy-l2s-' & rand & '/';
        var s3CopyDest   = variables.testPathS3 & 'copy-s2s-' & rand & '/';

        // Local download destination under the local test root
        var localDownload = variables.testLocalPath & 'download-' & rand & '/';

        describe( 'CSDirectoryCopy BIF (env-configured roundtrip)', () => {
            it( 'uploads local test directory to S3', () => {
                var res = CSDirectoryCopy( source = variables.testLocalPath, destination = s3UploadDest, recurse = true );
                expect( res.success ).toBeTrue();
                // Verify both test files are present in S3 listing
                var s3list = CSDirectoryList( path = s3UploadDest, recurse = true, listInfo = 'name', type='file' );
                expect( arrayFindNoCase( s3list, smallName ) ).toBeGTE( 1 );
                expect( arrayFindNoCase( s3list, largeName ) ).toBeGTE( 1 );
            });

            it( 'copies from S3 to another S3 prefix', () => {
                var res = CSDirectoryCopy( source = s3UploadDest, destination = s3CopyDest, recurse = true );
                expect( res.success ).toBeTrue();
                // Validate presence via filter
                var s3list2 = CSDirectoryList( path = s3CopyDest, recurse = true, listInfo = 'name', type='file' );
                expect( arrayFindNoCase( s3list2, smallName ) ).toBeGTE( 1 );
                expect( arrayFindNoCase( s3list2, largeName ) ).toBeGTE( 1 );
            });

            it( 'downloads from S3 back to a fresh local directory', () => {
                if( directoryExists( localDownload ) ) directoryDelete( localDownload, true );
                var res = CSDirectoryCopy( source = s3CopyDest, destination = localDownload, recurse = true );
                expect( res.success ).toBeTrue();
                // Check local files exist
                expect( fileExists( localDownload & smallName ) ).toBeTrue();
                expect( fileExists( localDownload & largeName ) ).toBeTrue();
                // Cleanup local download directory
                try { directoryDelete( localDownload, true ); } catch( any ignore ){}
            });
        });

        // Cleanup S3 destinations best-effort
        try { CSDirectoryDelete( s3UploadDest ); } catch( any ignore ){}
        try { CSDirectoryDelete( s3CopyDest ); } catch( any ignore ){}
    }
}